= 外部設計書
// :doctype: article - 文書のタイプ
// :lang: ja - 文書の言語
// :toc: left - 目次の位置
// :toclevels: 3 - 目次に表示する見出しのレベル
// :toc-title: 目次 - 目次自体のタイトル
// :sectnums: - セクションの自動番号付けの有効化
// :sectnumlevels: 6 - セクション番号付けレベル
// :sectlinks: - セクションタイトルをクリック可能なリンクの追加可否
// :sectanchors: - セクションへのリンクの追加可否
// :source-highlighter: rouge - コードブロックにRouge構文ハイライターを使用
// :icons: font - フォントベースのアイコン（例: Font Awesome）の有効可否
// :experimental: - AsciiDoc処理で実験的な機能の有効可否
// :stem: - STEM（科学、技術、工学、数学）の式をサポート可否
// :imagesdir: images - 画像が配置されているディレクトリ
// :pdf-theme: theme/document-theme.yml - カスタムPDFテーマ
// :pdf-fontsdir: theme/fonts - カスタムPDFフォントのディレクトリ
// :title-page: - 文書内のタイトルページの有無
// :revdate: {docdate} - 改訂日
// :revnumber: 改訂番号
// :author: 著者
:doctype: article
:lang: ja
:toc: left
:toclevels: 3
:toc-title: 目次
:sectnums:
:sectnumlevels: 6
:sectlinks:
:sectanchors:
:source-highlighter: rouge
:icons: font
:experimental:
:stem:
:imagesdir: images
:pdf-theme: theme/document-theme.yml
:pdf-fontsdir: theme/fonts
:title-page:
:revdate: {docdate}
:revnumber: 1.0
:author: システム開発株式会社

== 概要

=== 目的

本書は、顧客管理システムの外部設計内容を示し、開発・テスト・運用担当者間での共通理解を目的とする。本書に記載された機能仕様、画面設計、データ設計に基づいて実装を行う。

=== システム概要

本システムは、企業の顧客情報を一元管理し、営業活動を支援するWebベースの顧客管理システムである。営業担当者が顧客情報の登録・検索・更新を行い、商談履歴や見積情報を管理できる。想定利用者は営業部門の担当者約50名であり、ブラウザ（Chrome、Edge、Safari最新版）からアクセスする。

=== 対象範囲

本設計書で扱う機能は以下の通り：

* 顧客情報管理機能（登録・検索・更新・削除）
* 商談履歴管理機能
* 見積作成・管理機能
* レポート出力機能
* ユーザー管理機能

外部システムとの連携については、メール送信機能および会計システムとの連携を含む。

== システム構成

=== システム構成図

[plantuml, system-architecture, svg]
----
@startuml
actor User as "ユーザー"
User -- WebServer : HTTPリクエスト
WebServer -- Database : データアクセス
WebServer -- ExternalAPI : 外部連携
@enduml
----

=== サブシステム／モジュール構成

本システムは以下のモジュールで構成される：

* *フロントエンドモジュール*：ユーザーインターフェースを提供（React）
* *APIサーバーモジュール*：ビジネスロジックとデータアクセスを担当（Spring Boot）
* *データベースモジュール*：顧客情報、商談履歴、見積データを格納（PostgreSQL）
* *認証モジュール*：ユーザー認証とセッション管理（JWT）

=== 外部連携一覧

[cols="1,2,2,1", options="header"]
|===
|連携先 |連携方式 |連携内容 |頻度

|メールサーバー
|SMTP
|見積送信、通知メール配信
|都度

|会計システム
|REST API
|売上データ連携
|日次バッチ

|郵便番号検索API
|REST API
|住所自動入力
|都度
|===

=== 動作環境

==== サーバー環境

[cols="1,3", options="header"]
|===
|項目 |要件

|OS
|Linux（Ubuntu 22.04 LTS以降、または Red Hat Enterprise Linux 8以降）

|Webサーバー
|Nginx 1.20以降

|アプリケーションサーバー
|Java 17以降（OpenJDK推奨）、Spring Boot 3.x

|データベース
|PostgreSQL 14以降

|メモリ
|最小8GB、推奨16GB以上

|ディスク
|最小50GB、推奨100GB以上（ログ・データ保管領域含む）
|===

==== クライアント環境

[cols="1,3", options="header"]
|===
|項目 |要件

|ブラウザ
|Google Chrome 最新版、Microsoft Edge 最新版、Safari 最新版

|画面解像度
|最小1280×768、推奨1920×1080以上

|JavaScript
|有効化必須

|Cookie
|有効化必須（セッション管理に使用）
|===

==== ネットワーク要件

* インターネット接続：外部API連携のため必須
* HTTPS通信：TLS 1.2以降
* 推奨帯域：クライアント当たり1Mbps以上

== 機能設計

=== 機能一覧

[cols="1,2,3", options="header"]
|===
|機能ID |機能名 |概要

|F001
|顧客情報登録
|新規顧客情報を登録する

|F002
|顧客情報検索
|顧客名、会社名、担当者などで顧客を検索する

|F003
|顧客情報更新
|既存の顧客情報を更新する

|F004
|商談履歴管理
|商談の記録と履歴を管理する

|F005
|見積作成
|顧客向けの見積書を作成・PDF出力する

|F006
|レポート出力
|営業実績をグラフ・表で可視化する

|F007
|ユーザー管理
|システム利用者の登録・権限設定を行う
|===

=== 機能構成図

[plantuml, function-structure, svg]
----
@startuml
package "顧客管理機能" {
  [顧客情報登録]
  [顧客情報検索]
  [顧客情報更新]
}

package "営業支援機能" {
  [商談履歴管理]
  [見積作成]
  [レポート出力]
}

package "システム管理機能" {
  [ユーザー管理]
}

[顧客情報登録] --> [顧客情報検索]
[顧客情報検索] --> [商談履歴管理]
[商談履歴管理] --> [見積作成]
@enduml
----

=== 機能詳細仕様

==== F001：顧客情報登録

* *入力条件*：顧客名（必須）、会社名、電話番号、メールアドレス、住所、担当者名
* *出力結果*：登録完了メッセージ、顧客ID自動採番
* *処理概要*：
** 入力値のバリデーション（必須チェック、形式チェック）
** 重複チェック（同一メールアドレスの顧客が存在しないか確認）
** データベースへの登録
** 登録完了通知

* *処理シーケンス*：

[plantuml, customer-registration-sequence, svg]
----
@startuml
actor ユーザー
participant "画面\n（フロントエンド）" as UI
participant "APIサーバー" as API
participant "データベース" as DB

ユーザー -> UI: 顧客情報入力
ユーザー -> UI: 登録ボタンクリック
UI -> UI: 入力値検証
alt 検証エラー
    UI -> ユーザー: エラーメッセージ表示
else 検証OK
    UI -> API: POST /api/customers\n顧客情報送信
    API -> API: バリデーション
    API -> DB: SELECT\nメールアドレス重複チェック
    DB --> API: 検索結果
    alt 重複あり
        API --> UI: 409 Conflict\nエラーレスポンス
        UI -> ユーザー: 重複エラー表示
    else 重複なし
        API -> DB: INSERT\n顧客情報登録
        DB --> API: 登録成功\n顧客ID採番
        API --> UI: 200 OK\n登録完了
        UI -> ユーザー: 登録完了メッセージ表示
        UI -> UI: 顧客一覧画面へ遷移
    end
end
@enduml
----

==== F002：顧客情報検索

* *入力条件*：顧客名、会社名、担当者名（部分一致可）、登録日範囲
* *出力結果*：検索結果一覧（最大100件）
* *処理概要*：
** 検索条件に基づくデータベース検索
** 結果の一覧表示（ページネーション対応）
** 詳細画面への遷移リンク提供

== 画面設計

=== 画面一覧

[cols="1,2,2", options="header"]
|===
|画面ID |画面名 |用途

|S001
|ログイン画面
|ユーザー認証

|S002
|ダッシュボード画面
|システムのメイン画面、各機能へのナビゲーション

|S003
|顧客一覧画面
|顧客情報の検索・一覧表示

|S004
|顧客詳細画面
|顧客情報の詳細表示・編集

|S005
|顧客登録画面
|新規顧客情報の入力・登録

|S006
|商談履歴画面
|特定顧客の商談履歴表示・追加

|S007
|見積作成画面
|見積書の作成・編集

|S008
|レポート画面
|営業実績の可視化
|===

=== 画面遷移図

[plantuml, screen-transition, svg]
----
@startuml
[*] --> ログイン画面
ログイン画面 --> ダッシュボード画面 : 認証成功
ダッシュボード画面 --> 顧客一覧画面
ダッシュボード画面 --> レポート画面
顧客一覧画面 --> 顧客詳細画面 : 顧客選択
顧客一覧画面 --> 顧客登録画面 : 新規登録
顧客詳細画面 --> 商談履歴画面
顧客詳細画面 --> 見積作成画面
商談履歴画面 --> 見積作成画面
@enduml
----

=== 画面詳細設計

==== S003：顧客一覧画面

* *レイアウト*：
** ヘッダー：システム名、ユーザー名、ログアウトボタン
** 検索エリア：顧客名、会社名、担当者名の入力欄、検索ボタン
** 一覧エリア：検索結果のテーブル表示（顧客ID、顧客名、会社名、電話番号、登録日）
** フッター：ページネーション、新規登録ボタン

* *操作イベント*：
** 検索ボタンクリック：検索条件でデータ取得し一覧を更新
** 顧客行クリック：顧客詳細画面へ遷移
** 新規登録ボタンクリック：顧客登録画面へ遷移
** ページネーションクリック：該当ページのデータを取得

==== S005：顧客登録画面

* *レイアウト*：
** 入力フォーム：顧客名、会社名、電話番号、メールアドレス、郵便番号、住所、担当者名
** 住所自動入力ボタン（郵便番号から）
** 登録ボタン、キャンセルボタン

* *操作イベント*：
** 住所自動入力ボタンクリック：郵便番号APIで住所を取得し自動入力
** 登録ボタンクリック：入力値をバリデーション後、サーバーへ送信
** キャンセルボタンクリック：顧客一覧画面へ戻る

== 運用設計

=== 環境設定

==== 設定ファイル

* `application.yml`：データベース接続情報、外部API設定、ログレベル設定
* `environment.config`：環境変数（開発/ステージング/本番の切り替え）

==== 環境別設定

[cols="1,2,2", options="header"]
|===
|環境 |データベース |外部API

|開発
|localhost:5432
|テスト用エンドポイント

|ステージング
|staging-db.example.com
|ステージング用エンドポイント

|本番
|prod-db.example.com
|本番用エンドポイント
|===

==== 切り替え方針

環境変数 `APP_ENV` の値（development / staging / production）により、対応する設定ファイルを自動的に読み込む。

=== ログ設計

==== ログ種別

* *操作ログ*：ユーザーの操作履歴（ログイン、データ登録・更新・削除）
* *エラーログ*：システムエラー、例外情報、スタックトレース
* *アクセスログ*：HTTPリクエスト情報（URL、メソッド、ステータスコード、応答時間）

==== ログ出力項目

[cols="1,3", options="header"]
|===
|項目 |内容

|タイムスタンプ
|YYYY-MM-DD HH:MM:SS.mmm形式

|ログレベル
|DEBUG / INFO / WARN / ERROR

|ユーザーID
|操作ユーザーのID（未ログイン時は"anonymous"）

|操作内容
|実行した機能・アクション

|IPアドレス
|クライアントのIPアドレス

|メッセージ
|詳細メッセージまたはエラー内容
|===

==== 保管場所・ローテーション

* ログファイル：`/var/log/customer-system/app.log`
* ローテーション：日次、30日分保管
* バックアップ：圧縮後、別サーバーへ転送

== 付録

=== 用語集

API:: Application Programming Interfaceの略。アプリケーション間のインターフェース仕様。

JWT:: JSON Web Tokenの略。認証トークンの標準形式。

CRUD:: Create（作成）、Read（参照）、Update（更新）、Delete（削除）の頭文字。データの基本操作を指す。

REST:: Representational State Transferの略。Web API設計の原則。

バリデーション:: 入力データの妥当性チェック。必須チェック、形式チェック、範囲チェックなど。

ページネーション:: 大量データを複数ページに分割して表示する仕組み。

セッション:: ユーザーのログイン状態を保持する仕組み。

=== 参照資料

* 顧客管理システム要件定義書 v1.0
* 画面モックアップ（Figma）
* データベース設計書 v1.0
* Spring Boot公式ドキュメント：https://spring.io/projects/spring-boot
* React公式ドキュメント：https://react.dev/
* PostgreSQL公式ドキュメント：https://www.postgresql.org/docs/

=== 変更履歴

[cols="1,2,2,3", options="header"]
|===
|版数 |日付 |作成者 |変更内容

|1.0
|2025-11-02
|システム開発チーム
|初版作成
|===